# ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°åˆ†æãƒ¬ãƒãƒ¼ãƒˆ

> ä½œæˆæ—¥: 2026-01-22
> å¯¾è±¡: AI Character World ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“

## ã‚¨ã‚°ã‚¼ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒãƒªãƒ¼

| ã‚«ãƒ†ã‚´ãƒª | è©•ä¾¡ | å•é¡Œæ•° | é‡å¤§åº¦ |
|---------|------|--------|--------|
| ã‚³ãƒ¼ãƒ‰å“è³ª | B+ | 12 | ä¸­ |
| å‹å®šç¾© | B | 8 | ä¸­ã€œé«˜ |
| ä¾å­˜é–¢ä¿‚ | B- | 5 | é«˜ |
| ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° | B+ | 7 | ä¸­ |
| çŠ¶æ…‹ç®¡ç† | A- | 4 | ä½ã€œä¸­ |
| APIè¨­è¨ˆ | C+ | 9 | é«˜ |
| ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€  | B | 6 | ä¸­ |
| ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ« | B+ | 6 | ä¸­ |
| **ãƒ­ã‚¸ãƒƒã‚¯é‡è¤‡** | **C+** | **41** | **ä¸­ã€œé«˜** |
| **æŠ½è±¡åŒ–æ©Ÿä¼š** | **B-** | **10** | **ä¸­** |

### ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆçµ±è¨ˆ

- ç·TypeScriptãƒ•ã‚¡ã‚¤ãƒ«æ•°: 62
- ç·ã‚³ãƒ¼ãƒ‰è¡Œæ•°: ç´„11,500è¡Œ
- æœ€å¤§ãƒ•ã‚¡ã‚¤ãƒ«è¡Œæ•°: 1,610è¡Œï¼ˆSimulationEngine.tsï¼‰
- ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸: 0%
- ãƒ­ã‚¸ãƒƒã‚¯é‡è¤‡ç®‡æ‰€: 41ç®‡æ‰€ï¼ˆæ¨å®šå‰Šæ¸›å¯èƒ½è¡Œæ•°: ~340è¡Œï¼‰
- æŠ½è±¡åŒ–æ©Ÿä¼š: 10ç®‡æ‰€ï¼ˆDIã€å‹å®‰å…¨æ€§ã€ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³ç­‰ï¼‰

---

## ç›®æ¬¡

1. [Critical - å³åº§å¯¾å¿œ](#1-critical---å³åº§å¯¾å¿œ)
2. [High - 1-2é€±é–“ã§å¯¾å¿œ](#2-high---1-2é€±é–“ã§å¯¾å¿œ)
3. [Medium - 1ãƒ¶æœˆä»¥å†…](#3-medium---1ãƒ¶æœˆä»¥å†…)
4. [Low - é•·æœŸæ”¹å–„](#4-low---é•·æœŸæ”¹å–„)
5. [å‰¯ä½œç”¨ãƒªã‚¹ã‚¯è©•ä¾¡](#5-å‰¯ä½œç”¨ãƒªã‚¹ã‚¯è©•ä¾¡)
6. [æ¨å¥¨å®Ÿæ–½ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«](#6-æ¨å¥¨å®Ÿæ–½ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«)
7. [è©³ç´°åˆ†æ](#7-è©³ç´°åˆ†æ)
8. [ãƒ­ã‚¸ãƒƒã‚¯é‡è¤‡ã®è©³ç´°åˆ†æ](#8-ãƒ­ã‚¸ãƒƒã‚¯é‡è¤‡ã®è©³ç´°åˆ†æ)
9. [æŠ½è±¡åŒ–ãƒ»å …ç‰¢åŒ–ã®æ©Ÿä¼š](#9-æŠ½è±¡åŒ–å …ç‰¢åŒ–ã®æ©Ÿä¼š)

---

## 1. Critical - å³åº§å¯¾å¿œ

å‰¯ä½œç”¨ãƒªã‚¹ã‚¯ãŒä½ãã€å³åº§ã«å¯¾å¿œå¯èƒ½ãªé …ç›®ã€‚

### 1.1 æœªä½¿ç”¨ã‚³ãƒ¼ãƒ‰ã®å‰Šé™¤

| å¯¾è±¡ | ãƒ•ã‚¡ã‚¤ãƒ« | è¡Œ | å‰¯ä½œç”¨ |
|------|---------|---|--------|
| `easeInOutQuad`, `easeOutQuad` | `src/lib/movement.ts` | 15-21 | ãªã— |
| `SimulationEvent`, `SimulationEventType` | `src/server/simulation/types.ts` | 226-232 | ãªã— |
| `validateNPCConfig` | `src/lib/npcLoader.ts` | 50-68 | ãªã—ï¼ˆå®šç¾©ã®ã¿ã€æœªä½¿ç”¨ï¼‰ |
| ç©ºãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª | `src/components/providers/` | - | ãªã— |

### 1.2 é‡è¤‡ã‚³ãƒ¼ãƒ‰ã®çµ±åˆ

#### parseNodeIdToGridCoordï¼ˆ3ç®‡æ‰€ã§é‡è¤‡ï¼‰

| ãƒ•ã‚¡ã‚¤ãƒ« | è¡Œ |
|---------|---|
| `src/lib/facilityUtils.ts` | 8 |
| `src/lib/mapLoader.ts` | 64 |
| `src/server/simulation/actions/ActionExecutor.ts` | 406 |

**æ¨å¥¨**: `src/lib/nodeUtils.ts` ã‚’æ–°è¦ä½œæˆã—å…±é€šé–¢æ•°ã¨ã—ã¦çµ±åˆ

#### getDirection / getDirectionFromPositionsï¼ˆå®Œå…¨é‡è¤‡ï¼‰

| ãƒ•ã‚¡ã‚¤ãƒ« | é–¢æ•°å | è¡Œ |
|---------|--------|---|
| `src/lib/movement.ts` | `getDirection` | 23-32 |
| `src/server/simulation/CharacterSimulator.ts` | `getDirectionFromPositions` | 439-449 |

**æ¨å¥¨**: CharacterSimulatorã§`movement.ts`ã®`getDirection`ã‚’import

### 1.3 å‹å®šç¾©ã®åå‰è¡çªè§£æ¶ˆ

#### WorldStateï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ/ã‚µãƒ¼ãƒãƒ¼ã§ç•°ãªã‚‹æ§‹é€ ï¼‰

| ãƒ•ã‚¡ã‚¤ãƒ« | ç”¨é€” |
|---------|------|
| `src/types/world.ts:14-19` | ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç”¨ |
| `src/server/simulation/types.ts:98-106` | ã‚µãƒ¼ãƒãƒ¼ç”¨ |

**æ¨å¥¨**: `ClientWorldState` / `ServerWorldState` ã«åˆ†é›¢

#### GridConfigï¼ˆ3ç®‡æ‰€ã§ç•°ãªã‚‹æ„å‘³ï¼‰

| ãƒ•ã‚¡ã‚¤ãƒ« | ç”¨é€” |
|---------|------|
| `src/types/map.ts:95-99` | JSONè¨­å®šç”¨ï¼ˆGridConfigJsonï¼‰ |
| `src/data/maps/grid.ts:4-10` | å†…éƒ¨å‡¦ç†ç”¨ |
| `src/types/config.ts:39-44` | ãƒ¯ãƒ¼ãƒ«ãƒ‰è¨­å®šç”¨ |

**æ¨å¥¨**: å„ç”¨é€”ã«å¿œã˜ãŸãƒªãƒãƒ¼ãƒ ï¼ˆ`GridConfigJson`, `InternalGridConfig`, `WorldGridConfig`ï¼‰

---

## 2. High - 1-2é€±é–“ã§å¯¾å¿œ

### 2.1 å¾ªç’°ä¾å­˜ã®è§£æ¶ˆ

```
ç¾çŠ¶ã®å•é¡Œ:
types/behavior.ts â†’ server/simulation/types.ts (SimCharacter, SimNPC)
                  â†’ server/simulation/actions/definitions.ts (ActionId)
hooks/useSimulationSync.ts â†’ server/simulation/types.ts
```

**å½±éŸ¿**:
- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ«ã«ã‚µãƒ¼ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã‚‹ãƒªã‚¹ã‚¯
- å‹ã®è²¬ä»»ç¯„å›²ãŒä¸æ˜ç¢º

**æ¨å¥¨å¯¾å¿œ**:
1. `SimCharacter`, `SimNPC` ã‚’ `src/types/simulation.ts` ã«ç§»å‹•
2. `ActionId` ã‚’ `src/types/action.ts` ã«ç§»å‹•
3. `hooks/useSimulationSync.ts` ã®ä¾å­˜ã‚’å…±æœ‰å‹ã«å¤‰æ›´

### 2.2 å·¨å¤§ãƒ•ã‚¡ã‚¤ãƒ«ã®åˆ†å‰²

#### SimulationEngine.tsï¼ˆ1,610è¡Œï¼‰

| è²¬å‹™ | æ¨å¥¨åˆ†å‰²å…ˆ |
|------|-----------|
| æ™‚åˆ»ç®¡ç†ãƒ»ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ¸›è¡° | `TimeManager.ts` |
| ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç† | `ScheduleManager.ts` |
| æ°¸ç¶šåŒ– | `PersistenceManager.ts` |
| ã‚³ã‚¢åˆ¶å¾¡ | `SimulationEngine.ts`ï¼ˆç¸®å°ï¼‰ |

#### LLMBehaviorDecider.tsï¼ˆ1,058è¡Œï¼‰

| è²¬å‹™ | æ¨å¥¨åˆ†å‰²å…ˆ |
|------|-----------|
| ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ§‹ç¯‰ï¼ˆ600è¡Œè¶…ï¼‰ | `PromptBuilder.ts` |
| æ–½è¨­é¸æŠ | `FacilitySelector.ts` |
| ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æ›´æ–° | `ScheduleUpdater.ts` |
| è¡Œå‹•æ±ºå®šã‚³ã‚¢ | `LLMBehaviorDecider.ts`ï¼ˆç¸®å°ï¼‰ |

#### PixiAppSync.tsxï¼ˆ610è¡Œï¼‰

| è²¬å‹™ | æ¨å¥¨åˆ†å‰²å…ˆ |
|------|-----------|
| æç”» | `PixiRenderer.tsx` |
| ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ | `CharacterAnimator.tsx` |
| ãƒãƒƒãƒ—é·ç§» | `MapTransitionHandler.tsx` |

### 2.3 APIã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®è¿½åŠ 

**ç¾çŠ¶ã®å•é¡Œ**:
- èªè¨¼æ©Ÿæ§‹ãªã—ï¼ˆå…¨ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒç„¡èªè¨¼ã§ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ï¼‰
- å…¥åŠ›ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãªã—ï¼ˆå‹ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ã®ã¿ï¼‰
- ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãªã—

**æ¨å¥¨å¯¾å¿œ**:

```typescript
// 1. middleware.ts ã§ API ã‚­ãƒ¼æ¤œè¨¼
export function middleware(request: NextRequest) {
  const apiKey = request.headers.get('x-api-key')
  if (!apiKey || apiKey !== process.env.API_KEY) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }
}

// 2. Zod ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
const SimulationActionSchema = z.object({
  action: z.enum(['pause', 'unpause', 'toggle', 'start', 'stop'])
})

// 3. ãƒ¬ãƒ¼ãƒˆåˆ¶é™
const limiter = rateLimit({ interval: 60000, uniqueTokenPerInterval: 500 })
```

### 2.4 ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®çµ±ä¸€

| å•é¡Œç®‡æ‰€ | ãƒ•ã‚¡ã‚¤ãƒ« | è¡Œ | å¯¾å¿œ |
|---------|---------|---|------|
| ç©ºcatchãƒ–ãƒ­ãƒƒã‚¯ | `MapPreview.tsx` | 66 | ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°è¿½åŠ  |
| ãƒªã‚«ãƒãƒªãªã—catch | `PixiAppSync.tsx` | 99, 228, 339 | UIã‚¨ãƒ©ãƒ¼è¡¨ç¤º |
| ã‚µã‚¤ãƒ¬ãƒ³ãƒˆPromise | `SimulationEngine.ts` | 301, 331, 1200, 1278 | ãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯ |

**æ¨å¥¨**: ã‚«ã‚¹ã‚¿ãƒ ã‚¨ãƒ©ãƒ¼ã‚¯ãƒ©ã‚¹ã®å°å…¥

```typescript
// src/lib/errors.ts
export class MapLoadError extends Error {
  constructor(public mapId: string, message: string, public cause?: Error) {
    super(message)
    this.name = 'MapLoadError'
  }
}
```

---

## 3. Medium - 1ãƒ¶æœˆä»¥å†…

### 3.1 å‹ç¶™æ‰¿ã®æ´»ç”¨

**ç¾çŠ¶**: `SimCharacter`ãŒ`Character`ã®å…¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å†å®šç¾©

**æ¨å¥¨**:
```typescript
interface SimCharacter extends Character {
  navigation: SimNavigationState
  crossMapNavigation: SimCrossMapNavState | null
  conversation: ConversationState | null
  currentAction: ActionState | null
  // ... ã‚µãƒ¼ãƒãƒ¼å›ºæœ‰ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã¿
}
```

### 3.2 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒæ”¹å–„

| å•é¡Œ | ç¾çŠ¶ | æ¨å¥¨ | ãƒ•ã‚¡ã‚¤ãƒ« |
|------|------|------|---------|
| å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ãªã— | å­¤ç«‹ãƒ‡ãƒ¼ã‚¿ãƒªã‚¹ã‚¯ | CASCADE DELETEè¿½åŠ  | `SqliteStore.ts:119-147` |
| å‹ä¸æ•´åˆ | satietyç­‰ãŒINTEGER | REALã«ä¿®æ­£ | `SqliteStore.ts:82-99` |
| ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹é‡è¤‡ | schedules | æ˜ç¤ºçš„ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹å‰Šé™¤ | `SqliteStore.ts:129-130` |
| personalityæœªä¿å­˜ | DBã‚«ãƒ©ãƒ ãªã— | ALTER TABLEè¿½åŠ  | `SqliteStore.ts` |

### 3.3 SSEæœ€é©åŒ–

**ç¾çŠ¶**: æ¯tickå…¨çŠ¶æ…‹é€ä¿¡ï¼ˆ20fps Ã— å…¨ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ï¼‰

**æ¨å¥¨**:
1. å·®åˆ†æ›´æ–°ã®å°å…¥ï¼ˆå¤‰æ›´ãŒã‚ã£ãŸã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®ã¿é€ä¿¡ï¼‰
2. æ›´æ–°é »åº¦å‰Šæ¸›ï¼ˆ10tickæ¯ã«ã¾ã¨ã‚ã‚‹ï¼‰
3. åœ§ç¸®ã®æ¤œè¨

### 3.4 Zustand Storeæœ€é©åŒ–

**ç¾çŠ¶**: Mapå…¨ä½“ã‚³ãƒ”ãƒ¼ï¼ˆ`new Map(state.characters)`ï¼‰

**æ¨å¥¨**:
```typescript
// å€‹åˆ¥ã‚»ãƒ¬ã‚¯ã‚¿ã®è¿½åŠ 
const character = useCharacterStore(
  useCallback((s) => s.characters.get(characterId), [characterId])
)

// Immer middlewareæ¤œè¨
import { immer } from 'zustand/middleware/immer'
```

### 3.5 æ–½è¨­ã‚¿ã‚°ãƒãƒƒãƒ”ãƒ³ã‚°ã®çµ±åˆ

**ç¾çŠ¶**: 2ç®‡æ‰€ã§é¡ä¼¼å®šç¾©

| ãƒ•ã‚¡ã‚¤ãƒ« | å®šæ•°å | æˆ»ã‚Šå€¤å‹ |
|---------|--------|----------|
| `SimulationEngine.ts:28-37` | `TAG_TO_ACTIONS` | `string[]` |
| `LLMBehaviorDecider.ts:17-26` | `FACILITY_TAG_TO_ACTION` | `ActionId` |

**æ¨å¥¨**: `src/lib/facilityMapping.ts` ã«çµ±åˆ

---

## 4. Low - é•·æœŸæ”¹å–„

### 4.1 ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ æ”¹å–„

```
æ¨å¥¨æ§‹é€ :
src/
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ pixi/              # PixiJSé–¢é€£
â”‚   â”‚   â”œâ”€â”€ renderers.ts
â”‚   â”‚   â””â”€â”€ spritesheet.ts
â”‚   â”œâ”€â”€ algorithm/         # ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 
â”‚   â”‚   â”œâ”€â”€ pathfinding.ts
â”‚   â”‚   â””â”€â”€ movement.ts
â”‚   â””â”€â”€ loaders/           # ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰
â”‚       â””â”€â”€ dataLoaders.ts (çµ±åˆ)
â”œâ”€â”€ server/
â”‚   â””â”€â”€ simulation/
â”‚       â”œâ”€â”€ managers/      # åˆ†å‰²ã•ã‚ŒãŸãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼
â”‚       â”‚   â”œâ”€â”€ TimeManager.ts
â”‚       â”‚   â”œâ”€â”€ ScheduleManager.ts
â”‚       â”‚   â””â”€â”€ PersistenceManager.ts
â”‚       â”œâ”€â”€ navigation/    # ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
â”‚       â”‚   â””â”€â”€ crossMapNavigation.ts
â”‚       â””â”€â”€ utils/         # ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
â”‚           â””â”€â”€ facilityUtils.ts
```

### 4.2 ãƒ†ã‚¹ãƒˆã‚¤ãƒ³ãƒ•ãƒ©æ§‹ç¯‰

**æ¨å¥¨ãƒ†ã‚¹ãƒˆå¯¾è±¡ï¼ˆå„ªå…ˆé †ï¼‰**:

| ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« | ç†ç”± | å„ªå…ˆåº¦ |
|-----------|------|--------|
| `pathfinding.ts` | ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®æ­£ç¢ºæ€§ãŒé‡è¦ | é«˜ |
| `mapLoader.ts` | ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚¸ãƒƒã‚¯è¤‡é›‘ | é«˜ |
| `SimulationEngine.ts` | ã‚³ã‚¢ãƒ­ã‚¸ãƒƒã‚¯ | é«˜ |
| `ActionExecutor.ts` | ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ | ä¸­ |
| `grid.ts` | åº§æ¨™è¨ˆç®—ã®æ­£ç¢ºæ€§ | ä¸­ |

**æ¨å¥¨ãƒ„ãƒ¼ãƒ«**:
```json
{
  "devDependencies": {
    "vitest": "^2.0.0",
    "@testing-library/react": "^15.0.0",
    "playwright": "^1.45.0"
  }
}
```

### 4.3 ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ã‚¹ãƒ†ãƒ 

**ç¾çŠ¶**: `CREATE TABLE IF NOT EXISTS` ã®ã¿

**æ¨å¥¨**:
```typescript
// src/server/persistence/migrations/index.ts
interface Migration {
  version: number
  up: (db: Database) => void
  down: (db: Database) => void
}

// ã‚¹ã‚­ãƒ¼ãƒãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†
CREATE TABLE schema_version (
  version INTEGER PRIMARY KEY,
  applied_at INTEGER NOT NULL
);
```

### 4.4 ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´å‚™

- README.mdæ›´æ–°ï¼ˆç¾çŠ¶Next.jsãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼‰
- APIä»•æ§˜æ›¸ä½œæˆ
- ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³ä½œæˆ

### 4.5 ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç®¡ç†ã®çµ±ä¸€

**å•é¡Œ**:
- `characterLoader.ts` ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢é–¢æ•°ãªã—
- `mapLoader.ts` ã® `clearMapCache()` ãŒ `cachedMapConfigs` ã‚’ã‚¯ãƒªã‚¢ã—ãªã„

**æ¨å¥¨**:
```typescript
// characterLoader.ts ã«è¿½åŠ 
export function clearCharacterCache(): void {
  cachedConfigs = null
}

// mapLoader.ts ã‚’ä¿®æ­£
export function clearMapCache(): void {
  cachedMaps = null
  cachedMapConfigs = null  // è¿½åŠ 
}
```

---

## 5. å‰¯ä½œç”¨ãƒªã‚¹ã‚¯è©•ä¾¡

| å¯¾å¿œé …ç›® | ãƒªã‚¹ã‚¯ | ç†ç”± |
|---------|-------|------|
| æœªä½¿ç”¨ã‚³ãƒ¼ãƒ‰å‰Šé™¤ | âšª ãªã— | å‚ç…§ãªã—ç¢ºèªæ¸ˆã¿ |
| é‡è¤‡ã‚³ãƒ¼ãƒ‰çµ±åˆ | ğŸŸ¡ ä½ | å†…éƒ¨å®Ÿè£…ã®çµ±åˆã®ã¿ |
| å‹å®šç¾©ãƒªãƒãƒ¼ãƒ  | ğŸŸ¡ ä½ã€œä¸­ | importæ–‡ã®ä¿®æ­£ãŒå¿…è¦ |
| å¾ªç’°ä¾å­˜è§£æ¶ˆ | ğŸŸ  ä¸­ | è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¿®æ­£ãŒå¿…è¦ |
| å·¨å¤§ãƒ•ã‚¡ã‚¤ãƒ«åˆ†å‰² | ğŸŸ  ä¸­ | å¤–éƒ¨APIã¯ç¶­æŒã€å†…éƒ¨ãƒªãƒ•ã‚¡ã‚¯ã‚¿ã®ã¿ |
| APIèªè¨¼è¿½åŠ  | ğŸŸ¡ ä½ | ç ´å£Šçš„å¤‰æ›´ãªã—ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼è¿½åŠ ï¼‰ |
| DBã‚¹ã‚­ãƒ¼ãƒå¤‰æ›´ | ğŸ”´ é«˜ | ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å¿…è¦ã€ãƒ‡ãƒ¼ã‚¿ç§»è¡Œãƒªã‚¹ã‚¯ |

---

## 6. æ¨å¥¨å®Ÿæ–½ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«

### Week 1ï¼ˆCriticalï¼‰
- [ ] æœªä½¿ç”¨ã‚³ãƒ¼ãƒ‰å‰Šé™¤ï¼ˆ4ç®‡æ‰€ï¼‰
- [ ] é‡è¤‡ã‚³ãƒ¼ãƒ‰çµ±åˆï¼ˆparseNodeIdToGridCoord, getDirectionï¼‰
- [ ] ç©ºãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå‰Šé™¤ï¼ˆproviders/ï¼‰
- [ ] å‹åè¡çªè§£æ¶ˆï¼ˆWorldState, GridConfigï¼‰

### Week 2ï¼ˆHigh - å‹ãƒ»ä¾å­˜é–¢ä¿‚ï¼‰
- [ ] å¾ªç’°ä¾å­˜ã®è§£æ¶ˆï¼ˆtypes/behavior.tsï¼‰
- [ ] SimCharacterå‹ç¶™æ‰¿ã®å°å…¥
- [ ] types/index.ts ã®ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰exportæ”¹å–„

### Week 3ï¼ˆHigh - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ»ã‚¨ãƒ©ãƒ¼ï¼‰
- [ ] Zodå°å…¥ã€APIãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³è¿½åŠ 
- [ ] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°çµ±ä¸€
- [ ] ç©ºcatchãƒ–ãƒ­ãƒƒã‚¯ä¿®æ­£

### Week 4ï¼ˆHigh - åˆ†å‰²é–‹å§‹ï¼‰
- [ ] SimulationEngine.ts åˆ†å‰²ï¼ˆæ®µéšçš„ï¼‰
- [ ] LLMBehaviorDecider.ts åˆ†å‰²ï¼ˆæ®µéšçš„ï¼‰

### Month 2ä»¥é™ï¼ˆMedium/Lowï¼‰
- [ ] PixiAppSync.tsx åˆ†å‰²
- [ ] SSE/Zustandæœ€é©åŒ–
- [ ] DBã‚¹ã‚­ãƒ¼ãƒæ”¹å–„
- [ ] ãƒ†ã‚¹ãƒˆã‚¤ãƒ³ãƒ•ãƒ©æ§‹ç¯‰
- [ ] ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ æ”¹å–„

---

## 7. è©³ç´°åˆ†æ

### 7.1 ã‚³ãƒ¼ãƒ‰å“è³ªæŒ‡æ¨™

| æŒ‡æ¨™ | ç¾çŠ¶ | ç›®æ¨™ |
|------|------|------|
| æœ€å¤§ãƒ•ã‚¡ã‚¤ãƒ«è¡Œæ•° | 1,610è¡Œ | <500è¡Œ |
| 50è¡Œè¶…ã®é–¢æ•° | 8å€‹ | 0 |
| 100è¡Œè¶…ã®é–¢æ•° | 2å€‹ | 0 |
| å¾ªç’°ä¾å­˜ | 2ç®‡æ‰€ | 0 |
| ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ | 0% | >80% |
| anyä½¿ç”¨ | 0 | 0ï¼ˆç¶­æŒï¼‰ |

### 7.2 ãƒã‚¸ãƒƒã‚¯ãƒŠãƒ³ãƒãƒ¼ä¸€è¦§

| å®šæ•° | ãƒ•ã‚¡ã‚¤ãƒ« | è¡Œ | èª¬æ˜ä¸è¶³ |
|------|---------|---|---------|
| `INTERRUPT_THRESHOLD = 10` | SimulationEngine.ts | 67 | 10%ã®æ ¹æ‹  |
| `SYSTEM_AUTO_MOVE_INTERVAL = 3` | SimulationEngine.ts | 69 | 3ã®æ ¹æ‹  |
| `HEAD_ICON_Y_OFFSET = 50` | PixiAppSync.tsx | 349 | 50pxã®æ ¹æ‹  |
| `TOLERANCE = 2` | grid.ts | 165 | è¨±å®¹èª¤å·®ã®æ ¹æ‹  |
| `fadeSpeed = 2.0` | PixiAppSync.tsx | 347 | é€Ÿåº¦ã®æ ¹æ‹  |

### 7.3 JSDocä¸è¶³ç®‡æ‰€

| ãƒ•ã‚¡ã‚¤ãƒ« | é–¢æ•°/ã‚¯ãƒ©ã‚¹ |
|---------|------------|
| PixiAppSync.tsx | `updateSpriteAnimation`, `updatePathLine`, `updateNPCDirections` |
| SimulationEngine.ts | ã»ã¨ã‚“ã©ã®privateãƒ¡ã‚½ãƒƒãƒ‰ |
| grid.ts | `generateGridNodes`, `getWallGeometry` |
| LLMBehaviorDecider.ts | `buildActionDecisionPrompt`, `getRelevantFacilities` |

### 7.4 APIè©•ä¾¡

| ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | èªè¨¼ | ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ | ãƒ¬ãƒ¼ãƒˆåˆ¶é™ | ã‚­ãƒ£ãƒƒã‚·ãƒ¥ |
|---------------|------|---------------|-----------|----------|
| `/api/simulation` GET | âŒ | âŒ | âŒ | âŒ |
| `/api/simulation` POST | âŒ | âŒ | âŒ | N/A |
| `/api/simulation-stream` GET | âŒ | N/A | âŒ | âœ… |
| `/api/db` GET | âŒ | âŒ | âŒ | âŒ |
| `/api/test-error` | âŒ | âŒ | âŒ | N/A |

### 7.5 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è©•ä¾¡

| é …ç›® | çŠ¶æ…‹ |
|------|------|
| WALãƒ¢ãƒ¼ãƒ‰ | âœ… æœ‰åŠ¹ |
| ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ | âœ… ä½¿ç”¨ |
| å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ | âŒ ãªã— |
| ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ | âš ï¸ é‡è¤‡ã‚ã‚Š |
| å‹å®šç¾© | âš ï¸ ä¸€éƒ¨ä¸æ•´åˆ |
| ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ | âŒ ãªã— |

---

## ä»˜éŒ²: ãƒ•ã‚¡ã‚¤ãƒ«åˆ¥å•é¡Œä¸€è¦§

### src/server/simulation/SimulationEngine.ts
- è¡Œæ•°: 1,610ï¼ˆåˆ†å‰²å¿…è¦ï¼‰
- ãƒã‚¸ãƒƒã‚¯ãƒŠãƒ³ãƒãƒ¼: 2ç®‡æ‰€
- å¾ªç’°ä¾å­˜ã®èµ·ç‚¹
- ã‚µã‚¤ãƒ¬ãƒ³ãƒˆPromise: 4ç®‡æ‰€

### src/server/behavior/LLMBehaviorDecider.ts
- è¡Œæ•°: 1,058ï¼ˆåˆ†å‰²å¿…è¦ï¼‰
- buildActionDecisionPrompt: 142è¡Œ
- é‡è¤‡ãƒ­ã‚¸ãƒƒã‚¯: æ–½è¨­æ¤œç´¢

### src/components/world/PixiAppSync.tsx
- è¡Œæ•°: 610ï¼ˆåˆ†å‰²æ¨å¥¨ï¼‰
- tickerã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯: 138è¡Œ
- ãƒã‚¸ãƒƒã‚¯ãƒŠãƒ³ãƒãƒ¼: 2ç®‡æ‰€
- ãƒªã‚«ãƒãƒªãªã—catch: 3ç®‡æ‰€

### src/types/behavior.ts
- å¾ªç’°ä¾å­˜: server/simulation/types.ts
- BehaviorContext: 14ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆåˆ†å‰²æ¨å¥¨ï¼‰

### src/server/persistence/SqliteStore.ts
- å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ãªã—
- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹é‡è¤‡
- å‹ä¸æ•´åˆï¼ˆINTEGER vs REALï¼‰

---

## 8. ãƒ­ã‚¸ãƒƒã‚¯é‡è¤‡ã®è©³ç´°åˆ†æ

é–¢æ•°åã®é‡è¤‡ã ã‘ã§ãªãã€é¡ä¼¼ã—ãŸãƒ­ã‚¸ãƒƒã‚¯ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è©³ç´°ã«åˆ†æã—ãŸçµæœã€‚

### 8.1 åº§æ¨™å¤‰æ›ãƒ­ã‚¸ãƒƒã‚¯ã®é‡è¤‡

#### nodeId â†’ ã‚°ãƒªãƒƒãƒ‰åº§æ¨™ã®ãƒ‘ãƒ¼ã‚¹ï¼ˆ3ç®‡æ‰€ï¼‰

| ãƒ•ã‚¡ã‚¤ãƒ« | è¡Œ | é–¢æ•°å |
|---------|---|--------|
| `src/lib/facilityUtils.ts` | 8-20 | `parseNodeIdToGridCoord` |
| `src/lib/mapLoader.ts` | 64-73 | `parseNodeIdToGridCoord` |
| `src/server/simulation/actions/ActionExecutor.ts` | 406-415 | `parseNodeIdToGridCoord` |

```typescript
// 3ç®‡æ‰€ã§ã»ã¼åŒä¸€ã®ãƒ­ã‚¸ãƒƒã‚¯
function parseNodeIdToGridCoord(nodeId: string, gridPrefix: string): { row: number; col: number } | null {
  const parts = nodeId.split('-')
  if (parts.length < 3 || parts[0] !== gridPrefix) return null
  const row = parseInt(parts[1], 10)
  const col = parseInt(parts[2], 10)
  if (isNaN(row) || isNaN(col)) return null
  return { row, col }
}
```

**æ¨å¥¨**: `src/lib/gridUtils.ts` ã‚’æ–°è¦ä½œæˆã—çµ±åˆ

#### ã‚°ãƒªãƒƒãƒ‰åº§æ¨™ â†’ ãƒ”ã‚¯ã‚»ãƒ«åº§æ¨™ã®å¤‰æ›ï¼ˆ2ç®‡æ‰€ï¼‰

| ãƒ•ã‚¡ã‚¤ãƒ« | è¡Œ | é–¢æ•°å |
|---------|---|--------|
| `src/lib/mapLoader.ts` | 75-88 | `gridCoordToPixel` |
| `src/data/maps/grid.ts` | 46-51 | `tileToPixelPosition` |

```typescript
// mapLoader.ts
function gridCoordToPixel(coord, width, height, cols, rows) {
  const spacingX = width / (cols + 1)
  const spacingY = height / (rows + 1)
  return {
    x: Math.round(spacingX * (coord.col + 1)),
    y: Math.round(spacingY * (coord.row + 1)),
  }
}

// grid.tsï¼ˆåŒã˜è¨ˆç®—å¼ï¼‰
function tileToPixelPosition(row, col, spacing) {
  return {
    x: Math.round(spacing.x * (col + 1)),
    y: Math.round(spacing.y * (row + 1)),
  }
}
```

**æ¨å¥¨**: `grid.ts` ã® `tileToPixelPosition` ã‚’ export ã—ã¦ä¸€å…ƒåŒ–

#### ã‚¹ãƒšãƒ¼ã‚·ãƒ³ã‚°è¨ˆç®—ï¼ˆ3ç®‡æ‰€ï¼‰

| ãƒ•ã‚¡ã‚¤ãƒ« | è¡Œ |
|---------|---|
| `src/data/maps/grid.ts` | 39-44 |
| `src/data/maps/grid.ts` | 356-357 |
| `src/lib/mapLoader.ts` | 82-83 |

```typescript
// åŒã˜è¨ˆç®—ãŒ3ç®‡æ‰€ã«æ•£åœ¨
const spacingX = width / (cols + 1)
const spacingY = height / (rows + 1)
```

**æ¨å¥¨**: `getGridSpacing()` é–¢æ•°ã‚’ export ã—ã¦å…±æœ‰

---

### 8.2 éšœå®³ç‰©ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã®é‡è¤‡

#### ã‚¿ã‚¤ãƒ—åˆ¥ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼ˆ4ç®‡æ‰€ä»¥ä¸Šï¼‰

| ãƒ•ã‚¡ã‚¤ãƒ« | è¡Œ | ãƒ‘ã‚¿ãƒ¼ãƒ³ |
|---------|---|---------|
| `src/lib/facilityUtils.ts` | 41-55 | `obstacles.filter(obs => obs.type === 'zone')` |
| `src/lib/facilityUtils.ts` | 62-86 | `obstacles.filter(obs => obs.type === 'building')` |
| `src/data/maps/grid.ts` | 92-96 | `obstacles.filter(obs => obs.type === 'building')` |
| `src/data/maps/grid.ts` | 359 | `obstacles.filter(obs => obs.type === 'zone')` |
| `src/lib/mapLoader.ts` | 105 | `obstacles.filter(obs => obs.type === 'building')` |

```typescript
// ç¹°ã‚Šè¿”ã—å‡ºç¾ã™ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³
const zones = obstacles.filter((obs) => obs.type === 'zone')
const buildings = obstacles.filter((obs) => obs.type === 'building')
```

**æ¨å¥¨**: `src/lib/obstacleUtils.ts` ã«çµ±åˆ

```typescript
export function getObstaclesByType(obstacles: Obstacle[], type: 'zone' | 'building'): Obstacle[]
export function getZones(obstacles: Obstacle[]): Obstacle[]
export function getBuildings(obstacles: Obstacle[]): Obstacle[]
```

#### ã‚¿ã‚°ãƒ™ãƒ¼ã‚¹æ–½è¨­æ¤œç´¢ï¼ˆ2ç®‡æ‰€ï¼‰

| ãƒ•ã‚¡ã‚¤ãƒ« | è¡Œ |
|---------|---|
| `src/lib/facilityUtils.ts` | 102-121 |
| `src/server/behavior/LLMBehaviorDecider.ts` | 289-321 |

```typescript
// facilityUtils.ts
export function findObstaclesWithFacilityTag(obstacles: Obstacle[], tag: FacilityTag): Obstacle[] {
  return obstacles.filter(obs => obs.facility && obs.facility.tags.includes(tag))
}

// LLMBehaviorDecider.tsï¼ˆé¡ä¼¼ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
const hasRelevantTag = (tags: FacilityTag[]) => tags.some(tag => relevantTags.includes(tag))
```

**æ¨å¥¨**: `facilityUtils.ts` ã®é–¢æ•°ã‚’ LLMBehaviorDecider ã§å†åˆ©ç”¨

---

### 8.3 çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯ã®é‡è¤‡

#### ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼çŠ¶æ…‹åˆ¤å®šï¼ˆè¤‡æ•°ç®‡æ‰€ï¼‰

| ãƒ•ã‚¡ã‚¤ãƒ« | è¡Œ | ãƒã‚§ãƒƒã‚¯å†…å®¹ |
|---------|---|-------------|
| `SimulationEngine.ts` | 433-437 | `isCharacterIdle` |
| `CharacterSimulator.ts` | 68-72 | `isCharacterNavigating` |
| `CharacterSimulator.ts` | 89-91 | idle + no conversation |
| `SimulationEngine.ts` | 464-465 | idle + no pending |

```typescript
// SimulationEngine.ts
private isCharacterIdle(character: SimCharacter): boolean {
  return !character.currentAction &&
         !character.conversation?.isActive &&
         !character.navigation.isMoving
}

// CharacterSimulator.ts
if (character && !character.currentAction && !character.conversation?.isActive) {
  // åŒã˜æ¡ä»¶ã®ç¹°ã‚Šè¿”ã—
}
```

**æ¨å¥¨**: `src/server/simulation/characterState.ts` ã‚’æ–°è¦ä½œæˆ

```typescript
export function isCharacterIdle(character: SimCharacter): boolean
export function isCharacterNavigating(character: SimCharacter): boolean
export function canStartNewAction(character: SimCharacter): boolean
```

---

### 8.4 å­˜åœ¨ãƒã‚§ãƒƒã‚¯ã®é‡è¤‡

#### ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼/ãƒãƒƒãƒ—å–å¾—å¾Œã®nullãƒã‚§ãƒƒã‚¯ï¼ˆ6ç®‡æ‰€ä»¥ä¸Šï¼‰

| ãƒ•ã‚¡ã‚¤ãƒ« | è¡Œ |
|---------|---|
| `SimulationEngine.ts` | 441-442 |
| `SimulationEngine.ts` | 462-463 |
| `SimulationEngine.ts` | 567-568 |
| `CharacterSimulator.ts` | 219-220 |
| `CharacterSimulator.ts` | 245-246 |
| `ActionExecutor.ts` | 456-459 |

```typescript
// ç¹°ã‚Šè¿”ã—å‡ºç¾ã™ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³
const character = this.worldState.getCharacter(characterId)
if (!character) return

const character = this.worldState.getCharacter(characterId)
if (!character) return false

const character = this.worldState.getCharacter(characterId)
if (!character) {
  return { canExecute: false, reason: 'Character not found' }
}
```

**æ¨å¥¨**: `WorldStateManager` ã«ãƒ˜ãƒ«ãƒ‘ãƒ¼ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿½åŠ 

```typescript
getCharacterOrThrow(id: string): SimCharacter
withCharacter<T>(id: string, callback: (char: SimCharacter) => T, fallback?: T): T | undefined
```

---

### 8.5 å…¨ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®é‡è¤‡

#### åŒä¸€ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ãƒ«ãƒ¼ãƒ—ï¼ˆ5ç®‡æ‰€ä»¥ä¸Šï¼‰

| ãƒ•ã‚¡ã‚¤ãƒ« | è¡Œ | ç›®çš„ |
|---------|---|------|
| `SimulationEngine.ts` | 399-427 | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–° |
| `SimulationEngine.ts` | 476-486 | è¡Œå‹•æ±ºå®š |
| `SimulationEngine.ts` | 731-767 | ãƒšãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å‡¦ç† |
| `ActionExecutor.ts` | 63-69 | ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ›´æ–° |
| `CharacterSimulator.ts` | 36-65 | ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æ›´æ–° |

```typescript
// ç¹°ã‚Šè¿”ã—å‡ºç¾ã™ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³
const characters = this.worldState.getAllCharacters()
for (const character of characters) {
  if (someCondition(character)) continue
  // å‡¦ç†
}
```

**æ¨å¥¨**: é«˜éšé–¢æ•°ã§æŠ½è±¡åŒ–

```typescript
// WorldStateManager ã«è¿½åŠ 
forEachCharacter(callback: (character: SimCharacter) => void): void
forEachIdleCharacter(callback: (character: SimCharacter) => void): void
filterCharacters(predicate: (character: SimCharacter) => boolean): SimCharacter[]
```

---

### 8.6 æ™‚åˆ»å‡¦ç†ã®é‡è¤‡

#### æ™‚åˆ»ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆ3ç®‡æ‰€ï¼‰

| ãƒ•ã‚¡ã‚¤ãƒ« | è¡Œ | ãƒ‘ã‚¿ãƒ¼ãƒ³ |
|---------|---|---------|
| `SimulationEngine.ts` | 1247 | `${hour}:${minute.padStart(2, '0')}` |
| `LLMBehaviorDecider.ts` | 556 | `${hour}:${minute.padStart(2, '0')}` |
| `LLMBehaviorDecider.ts` | 843-845 | æ™‚åˆ»æ–‡å­—åˆ—ã®ãƒ‘ãƒ¼ã‚¹ |

```typescript
// ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
const timeStr = `${String(currentTime.hour).padStart(2, '0')}:${String(currentTime.minute).padStart(2, '0')}`

// ãƒ‘ãƒ¼ã‚¹
const timeParts = entry.time.split(':')
const h = parseInt(timeParts[0], 10)
const m = parseInt(timeParts[1], 10)
```

**æ¨å¥¨**: `src/lib/timeUtils.ts` ã‚’æ–°è¦ä½œæˆ

```typescript
export function formatTime(time: WorldTime): string
export function parseTimeString(timeStr: string): { hour: number; minute: number } | null
export function timeToMinutes(time: WorldTime): number
export function compareTime(a: WorldTime, b: WorldTime): number
```

---

### 8.7 è¨­å®šå€¤å–å¾—ãƒ‘ã‚¿ãƒ¼ãƒ³ã®é‡è¤‡

#### isConfigLoaded + getConfig ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆ4ç®‡æ‰€ï¼‰

| ãƒ•ã‚¡ã‚¤ãƒ« | è¡Œ | å–å¾—å†…å®¹ |
|---------|---|---------|
| `src/data/maps/grid.ts` | 299-310 | ã‚°ãƒªãƒƒãƒ‰ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ |
| `src/lib/movement.ts` | 41-48 | ç§»å‹•é€Ÿåº¦ |
| `src/lib/mapLoader.ts` | 136 | ãƒãƒƒãƒ—ãƒ‘ã‚¹ |
| `src/lib/characterLoader.ts` | 13 | ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ‘ã‚¹ |

```typescript
// ç¹°ã‚Šè¿”ã—å‡ºç¾ã™ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³
export function getGridDefaults(): GridDefaults {
  if (isConfigLoaded()) {
    const config = getConfig()
    return {
      cols: config.grid.defaultCols,
      // ...
    }
  }
  return FALLBACK_DEFAULTS
}

export function getMovementSpeed(): number {
  if (isConfigLoaded()) {
    return getConfig().movement.speed
  }
  return DEFAULT_MOVEMENT_SPEED
}
```

**æ¨å¥¨**: `worldConfigLoader.ts` ã«æ±ç”¨ã‚²ãƒƒã‚¿ãƒ¼ã‚’è¿½åŠ 

```typescript
export function getConfigValue<T>(getter: (config: WorldConfig) => T, fallback: T): T {
  if (isConfigLoaded()) {
    return getter(getConfig())
  }
  return fallback
}

// ä½¿ç”¨ä¾‹
export const getMovementSpeed = () => getConfigValue(c => c.movement.speed, DEFAULT_SPEED)
```

---

### 8.8 æ–½è¨­æƒ…å ±æ§‹ç¯‰ã®é‡è¤‡

#### æ–½è¨­ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆç”Ÿæˆï¼ˆ2ç®‡æ‰€ï¼‰

| ãƒ•ã‚¡ã‚¤ãƒ« | è¡Œ |
|---------|---|
| `LLMBehaviorDecider.ts` | 289-321 |
| `SimulationEngine.ts` | 1024-1046 |

```typescript
// LLMBehaviorDecider.ts
results.push({
  id: f.id,
  label: f.label,
  tags: f.tags,
  cost: f.cost,
  distance: 0,
  mapId: context.character.currentMapId,
  availableActions: f.availableActions,
})

// SimulationEngine.ts
facilities.push({
  id: obstacle.id,
  label: obstacle.label || obstacle.id,
  tags: obstacle.facility.tags,
  cost: obstacle.facility.cost,
  availableActions,
})
```

**æ¨å¥¨**: `src/lib/facilityBuilder.ts` ã‚’æ–°è¦ä½œæˆ

```typescript
export function buildFacilityInfo(
  obstacle: Obstacle,
  mapId: string,
  distance: number,
  availableActions?: string[]
): NearbyFacility
```

---

### 8.9 ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æ“ä½œã®é‡è¤‡

#### ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å¤‰æ›ãƒ»æ›´æ–°ï¼ˆ2ç®‡æ‰€ï¼‰

| ãƒ•ã‚¡ã‚¤ãƒ« | è¡Œ | æ“ä½œ |
|---------|---|------|
| `LLMBehaviorDecider.ts` | 449-462 | LLMå¿œç­” â†’ å†…éƒ¨å½¢å¼å¤‰æ› |
| `SimulationEngine.ts` | 1143-1189 | ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«é…åˆ—ã®æ›´æ–° |

**æ¨å¥¨**: `src/lib/scheduleUtils.ts` ã‚’æ–°è¦ä½œæˆ

```typescript
export function convertScheduleUpdate(update: LLMScheduleUpdate): ScheduleUpdate | undefined
export function applyScheduleUpdate(entries: ScheduleEntry[], update: ScheduleUpdate): ScheduleEntry[]
export function sortScheduleEntries(entries: ScheduleEntry[]): ScheduleEntry[]
```

---

### 8.10 æ¨å¥¨ã•ã‚Œã‚‹å…±é€šåŒ–ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§

| æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ« | çµ±åˆå¯¾è±¡ | å„ªå…ˆåº¦ |
|-------------|---------|--------|
| `src/lib/gridUtils.ts` | åº§æ¨™å¤‰æ›ãƒ»ãƒ‘ãƒ¼ã‚¹ãƒ»ã‚¹ãƒšãƒ¼ã‚·ãƒ³ã‚° | é«˜ |
| `src/lib/obstacleUtils.ts` | éšœå®³ç‰©ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ãƒ»ã‚¿ã‚¤ãƒ—åˆ¤å®š | é«˜ |
| `src/lib/timeUtils.ts` | æ™‚åˆ»ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒ»ãƒ‘ãƒ¼ã‚¹ãƒ»æ¯”è¼ƒ | ä¸­ |
| `src/lib/facilityBuilder.ts` | æ–½è¨­æƒ…å ±ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆç”Ÿæˆ | ä¸­ |
| `src/lib/scheduleUtils.ts` | ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å¤‰æ›ãƒ»æ“ä½œ | ä¸­ |
| `src/server/simulation/characterState.ts` | çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯é–¢æ•° | é«˜ |

---

### 8.11 ãƒ­ã‚¸ãƒƒã‚¯é‡è¤‡ã®çµ±è¨ˆ

| ã‚«ãƒ†ã‚´ãƒª | é‡è¤‡ç®‡æ‰€æ•° | æ¨å®šå‰Šæ¸›è¡Œæ•° |
|---------|-----------|-------------|
| åº§æ¨™å¤‰æ› | 8 | ~80è¡Œ |
| éšœå®³ç‰©ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚° | 6 | ~50è¡Œ |
| çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯ | 5 | ~30è¡Œ |
| å­˜åœ¨ç¢ºèª | 6 | ~20è¡Œ |
| ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ | 5 | ~40è¡Œ |
| æ™‚åˆ»å‡¦ç† | 3 | ~20è¡Œ |
| è¨­å®šå€¤å–å¾— | 4 | ~30è¡Œ |
| æ–½è¨­æ§‹ç¯‰ | 2 | ~30è¡Œ |
| ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æ“ä½œ | 2 | ~40è¡Œ |
| **åˆè¨ˆ** | **41** | **~340è¡Œ** |

---

## 9. æŠ½è±¡åŒ–ãƒ»å …ç‰¢åŒ–ã®æ©Ÿä¼š

ã‚³ãƒ¼ãƒ‰ã®ä¿å®ˆæ€§ã€ãƒ†ã‚¹ã‚¿ãƒ“ãƒªãƒ†ã‚£ã€æ‹¡å¼µæ€§ã‚’å‘ä¸Šã•ã›ã‚‹æŠ½è±¡åŒ–ã®æ©Ÿä¼šã€‚

### 9.1 ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹/æŠ½è±¡ã‚¯ãƒ©ã‚¹ã®å°å…¥

#### StateStoreæŠ½è±¡åŒ–ã®æ”¹å–„

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/server/persistence/StateStore.ts`

**ç¾çŠ¶**: ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã¯å­˜åœ¨ã™ã‚‹ãŒå®Ÿè£…ã¯`SqliteStore`ã®ã¿

**æ¨å¥¨**:
```typescript
// åŸºåº•ã‚¯ãƒ©ã‚¹ã§å…±é€šå‡¦ç†ã‚’å®Ÿè£…
abstract class BaseStateStore implements StateStore {
  protected abstract doSaveState(state: SerializedWorldState): Promise<void>
  protected abstract doLoadState(): Promise<SerializedWorldState | null>

  async saveState(state: SerializedWorldState): Promise<void> {
    try {
      await this.doSaveState(state)
    } catch (error) {
      throw new StateStoreError('Save failed', error)
    }
  }
}

// ãƒ†ã‚¹ãƒˆç”¨MemoryStore
class MemoryStore extends BaseStateStore { /* ... */ }
```

**åŠ¹æœ**: ãƒ†ã‚¹ãƒˆå®¹æ˜“æ€§å‘ä¸Šã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°çµ±ä¸€

---

#### BehaviorDecideræˆ¦ç•¥ãƒ‘ã‚¿ãƒ¼ãƒ³

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/server/behavior/LLMBehaviorDecider.ts`

**ç¾çŠ¶**: LLMBehaviorDeciderãŒå”¯ä¸€ã®å®Ÿè£…

**æ¨å¥¨**:
```typescript
interface DecisionStrategy {
  canHandle(context: BehaviorContext): boolean
  decide(context: BehaviorContext): Promise<BehaviorDecision>
  priority: number
}

abstract class BaseBehaviorDecider implements BehaviorDecider {
  protected strategies: DecisionStrategy[] = []

  addStrategy(strategy: DecisionStrategy): this {
    this.strategies.push(strategy)
    this.strategies.sort((a, b) => b.priority - a.priority)
    return this
  }

  async decide(context: BehaviorContext): Promise<BehaviorDecision> {
    for (const strategy of this.strategies) {
      if (strategy.canHandle(context)) {
        return await strategy.decide(context)
      }
    }
    return this.defaultDecision(context)
  }
}

// ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹å®Ÿè£…ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ï¼‰
class RuleBasedDecider extends BaseBehaviorDecider {
  constructor() {
    super()
    this.addStrategy(new StatusInterruptStrategy())
    this.addStrategy(new ScheduleBasedStrategy())
    this.addStrategy(new IdleStrategy())
  }
}
```

**åŠ¹æœ**: è¤‡æ•°æ±ºå®šãƒ­ã‚¸ãƒƒã‚¯ã®çµ„ã¿åˆã‚ã›ã€LLMã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯

---

#### ActionHandleræŠ½è±¡åŒ–

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/server/simulation/actions/ActionExecutor.ts`

**ç¾çŠ¶**: ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®šç¾©ã¨å®Ÿè¡ŒãŒå¯†çµåˆ

**æ¨å¥¨**:
```typescript
interface ActionHandler {
  canExecute(context: ActionContext): ExecutionResult
  execute(context: ActionContext): Promise<ActionResult>
  onComplete(context: ActionContext, result: ActionResult): void
}

class ActionExecutor {
  private handlers = new Map<ActionId, ActionHandler>()

  registerHandler(actionId: ActionId, handler: ActionHandler): void {
    this.handlers.set(actionId, handler)
  }
}

// å…·ä½“çš„ãªãƒãƒ³ãƒ‰ãƒ©ãƒ¼
class EatActionHandler implements ActionHandler {
  canExecute(context: ActionContext): ExecutionResult { /* ... */ }
  execute(context: ActionContext): Promise<ActionResult> { /* ... */ }
  onComplete(context: ActionContext, result: ActionResult): void { /* ... */ }
}
```

**åŠ¹æœ**: æ–°ã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¿½åŠ å®¹æ˜“ã€å„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒ†ã‚¹ãƒˆç‹¬ç«‹ã€SRPéµå®ˆ

---

### 9.2 ã‚¸ã‚§ãƒãƒªã‚¯ã‚¹ã«ã‚ˆã‚‹æ±ç”¨åŒ–

#### ã‚¹ãƒˆã‚¢ã®CRUDæ“ä½œ

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/server/persistence/SqliteStore.ts`

**ç¾çŠ¶**: å„ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã”ã¨ã«åŒã˜ãƒ‘ã‚¿ãƒ¼ãƒ³ã®CRUDãƒ¡ã‚½ãƒƒãƒ‰

**æ¨å¥¨**:
```typescript
abstract class GenericStore<TEntity, TKey> {
  abstract tableName: string
  abstract serialize(entity: TEntity): Record<string, unknown>
  abstract deserialize(row: Record<string, unknown>): TEntity
  abstract getKey(entity: TEntity): TKey

  async save(entity: TEntity): Promise<void> {
    const row = this.serialize(entity)
    const key = this.getKey(entity)
    await this.db.upsert(this.tableName, key, row)
  }

  async load(key: TKey): Promise<TEntity | null> {
    const row = await this.db.query(this.tableName, key)
    return row ? this.deserialize(row) : null
  }
}

class CharacterStore extends GenericStore<SimCharacter, string> {
  tableName = 'character_states'
  // ...
}
```

**åŠ¹æœ**: ã‚³ãƒ¼ãƒ‰é‡è¤‡å‰Šæ¸›ã€æ–°ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£è¿½åŠ å®¹æ˜“ã€å‹å®‰å…¨æ€§å‘ä¸Š

---

#### ã‚¸ã‚§ãƒãƒªãƒƒã‚¯ãƒãƒªãƒ‡ãƒ¼ã‚¿ãƒ¼

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/lib/mapLoader.ts`

**æ¨å¥¨**:
```typescript
interface ValidationRule<T> {
  name: string
  validate(value: T): ValidationResult
}

class Validator<T> {
  private rules: ValidationRule<T>[] = []

  addRule(rule: ValidationRule<T>): this {
    this.rules.push(rule)
    return this
  }

  validate(values: T[]): ValidationReport {
    const errors: ValidationError[] = []
    for (const value of values) {
      for (const rule of this.rules) {
        const result = rule.validate(value)
        if (!result.isValid) {
          errors.push({ rule: rule.name, value, message: result.message })
        }
      }
    }
    return { isValid: errors.length === 0, errors }
  }
}

// ä½¿ç”¨ä¾‹
const obstacleValidator = new Validator<ObstacleConfigJson>()
  .addRule(new RequiredFieldsRule(['row', 'col', 'tileWidth', 'tileHeight']))
  .addRule(new MinSizeRule({ building: 2, zone: 4 }))
```

**åŠ¹æœ**: ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ«å†åˆ©ç”¨ã€ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸çµ±ä¸€

---

### 9.3 å‹å®‰å…¨æ€§ã®å‘ä¸Š

#### Brandedå‹ï¼ˆIDã®ç¨®é¡åŒºåˆ¥ï¼‰

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/types/character.ts`, `src/types/map.ts`

**ç¾çŠ¶**: ã™ã¹ã¦ã®IDãŒ`string`å‹ã§åŒºåˆ¥ã•ã‚Œãªã„

**æ¨å¥¨**:
```typescript
type Brand<K, T> = K & { __brand: T }

type CharacterId = Brand<string, 'CharacterId'>
type MapId = Brand<string, 'MapId'>
type NodeId = Brand<string, 'NodeId'>
type NPCId = Brand<string, 'NPCId'>

// ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
function createCharacterId(id: string): CharacterId {
  return id as CharacterId
}

// ä½¿ç”¨ä¾‹ - ã“ã‚Œã¯ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹
interface Character {
  id: CharacterId
  currentMapId: MapId
  currentNodeId: NodeId
}

const char: Character = {
  id: 'char-1',  // Error: string is not assignable to CharacterId
}
```

**åŠ¹æœ**: IDã®ç¨®é¡é–“é•ã„ã‚’ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã«æ¤œå‡ºã€ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°å®‰å…¨æ€§å‘ä¸Š

---

#### Discriminated Unionå‹

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/types/behavior.ts`

**ç¾çŠ¶**:
```typescript
interface BehaviorDecision {
  type: 'action' | 'move' | 'idle'
  actionId?: ActionId      // typeã«ã‚ˆã£ã¦å¿…è¦æ€§ãŒç•°ãªã‚‹
  targetNodeId?: string    // ã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«ã ã‚‰ã‘
  targetMapId?: string
}
```

**æ¨å¥¨**:
```typescript
type ActionDecision = {
  type: 'action'
  actionId: ActionId  // å¿…é ˆ
  targetFacilityId?: string
  reason?: string
}

type MoveDecision = {
  type: 'move'
  targetMapId: string  // å¿…é ˆ
  targetNodeId?: string
  reason?: string
}

type IdleDecision = {
  type: 'idle'
  reason: string  // å¿…é ˆ
}

export type BehaviorDecision = ActionDecision | MoveDecision | IdleDecision

// ä½¿ç”¨ä¾‹ï¼ˆå‹ã‚¬ãƒ¼ãƒ‰ãŒè‡ªå‹•ã§åŠ¹ãï¼‰
function handleDecision(decision: BehaviorDecision) {
  switch (decision.type) {
    case 'action':
      console.log(decision.actionId)  // ç¢ºå®Ÿã«å­˜åœ¨
      break
    case 'move':
      console.log(decision.targetMapId)  // ç¢ºå®Ÿã«å­˜åœ¨
      break
    case 'idle':
      console.log(decision.reason)  // ç¢ºå®Ÿã«å­˜åœ¨
      break
  }
}
```

**åŠ¹æœ**: å‹å®‰å…¨æ€§å¤§å¹…å‘ä¸Šã€å®Ÿè¡Œæ™‚ã‚¨ãƒ©ãƒ¼å‰Šæ¸›ã€IDEè£œå®Œå‘ä¸Š

---

### 9.4 ä¾å­˜æ€§æ³¨å…¥ï¼ˆDIï¼‰

#### SimulationEngineã®DI

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/server/simulation/SimulationEngine.ts:78-102`

**ç¾çŠ¶**:
```typescript
constructor(config, stateStore?) {
  this.behaviorDecider = new LLMBehaviorDecider()  // ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰
}
```

**æ¨å¥¨**:
```typescript
interface SimulationDependencies {
  worldState: WorldStateManager
  characterSimulator: CharacterSimulator
  actionExecutor: ActionExecutor
  behaviorDecider: BehaviorDecider  // ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹
  stateStore: StateStore
}

class SimulationEngine {
  constructor(
    private config: SimulationConfig,
    private deps: SimulationDependencies
  ) {}
}

// ãƒ•ã‚¡ã‚¯ãƒˆãƒªãƒ¼é–¢æ•°
function createSimulationEngine(
  config?: Partial<SimulationConfig>,
  overrides?: Partial<SimulationDependencies>
): SimulationEngine {
  const worldState = overrides?.worldState ?? new WorldStateManager()

  const deps: SimulationDependencies = {
    worldState,
    behaviorDecider: overrides?.behaviorDecider ?? new LLMBehaviorDecider(),
    stateStore: overrides?.stateStore ?? new SqliteStore(),
    // ...
  }

  return new SimulationEngine({ ...DEFAULT_CONFIG, ...config }, deps)
}

// ãƒ†ã‚¹ãƒˆç”¨
const engine = createSimulationEngine({}, {
  behaviorDecider: new MockBehaviorDecider(),
  stateStore: new MemoryStore(),
})
```

**åŠ¹æœ**: ãƒ†ã‚¹ãƒˆå®¹æ˜“ã€å®Ÿè£…åˆ‡ã‚Šæ›¿ãˆç°¡å˜ã€ä¾å­˜é–¢ä¿‚æ˜ç¤ºçš„

---

#### LLMã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®DI

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/server/llm/client.ts`

**ç¾çŠ¶**: ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¾å­˜

```typescript
let model: LanguageModel | null = null  // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
```

**æ¨å¥¨**:
```typescript
interface LLMProvider {
  generateText(prompt: string, options?: GenerateOptions): Promise<string>
  generateObject<T>(prompt: string, schema: z.Schema<T>): Promise<T>
}

class LLMClient {
  constructor(private provider: LLMProvider, private errorHandler: ErrorHandler) {}

  async generateText(prompt: string, options?: GenerateOptions): Promise<string> {
    try {
      const result = await this.provider.generateText(prompt, options)
      this.errorHandler.resetFailureCount()
      return result
    } catch (error) {
      await this.errorHandler.handleError(error)
      throw error
    }
  }
}

// ä½¿ç”¨ä¾‹ï¼ˆDIï¼‰
class LLMBehaviorDecider implements BehaviorDecider {
  constructor(private llmClient: LLMClient) {}
}
```

**åŠ¹æœ**: ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹æ’é™¤ã€ãƒ†ã‚¹ãƒˆä¸¦åˆ—å®Ÿè¡Œå¯èƒ½ã€ãƒ¢ãƒƒã‚¯å®¹æ˜“

---

### 9.5 Resultå‹/Optionå‹ã®å°å…¥

#### ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®çµ±ä¸€

**ç¾çŠ¶**: ä¾‹å¤–ã€null/undefinedã€ç©ºé…åˆ—ãŒæ··åœ¨

**æ¨å¥¨**:
```typescript
// Resultå‹
type Result<T, E = Error> =
  | { ok: true; value: T }
  | { ok: false; error: E }

function ok<T>(value: T): Result<T, never> {
  return { ok: true, value }
}

function err<E>(error: E): Result<never, E> {
  return { ok: false, error }
}

// å‹å®‰å…¨ãªã‚¨ãƒ©ãƒ¼å®šç¾©
type ActionExecutionError =
  | { type: 'character_not_found'; characterId: string }
  | { type: 'already_executing'; currentAction: ActionId }
  | { type: 'insufficient_funds'; required: number; available: number }

function canExecuteAction(
  characterId: string,
  actionId: ActionId
): Result<void, ActionExecutionError> {
  const character = this.worldState.getCharacter(characterId)
  if (!character) {
    return err({ type: 'character_not_found', characterId })
  }

  if (character.currentAction) {
    return err({ type: 'already_executing', currentAction: character.currentAction.actionId })
  }

  return ok(undefined)
}

// ä½¿ç”¨ä¾‹
const result = canExecuteAction('char-1', 'eat')
if (!result.ok) {
  switch (result.error.type) {
    case 'character_not_found':
      console.log(`Character ${result.error.characterId} not found`)
      break
    case 'insufficient_funds':
      console.log(`Need ${result.error.required}, have ${result.error.available}`)
      break
  }
}
```

**åŠ¹æœ**: ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°çµ±ä¸€ã€å‹å®‰å…¨ãªã‚¨ãƒ©ãƒ¼å‡¦ç†ã€ã‚¨ãƒ©ãƒ¼ç†ç”±æ˜ç¢ºåŒ–

---

### 9.6 ä¸å¤‰æ€§ã®å¼·åŒ–

#### Readonlyå‹ã®æ´»ç”¨

**æ¨å¥¨**:
```typescript
interface SimCharacter {
  readonly id: string
  readonly name: string
  readonly sprite: Readonly<SpriteConfig>
  money: number  // å¤‰æ›´å¯èƒ½
  satiety: number
  position: Readonly<Position>  // ç½®ãæ›ãˆã®ã¿
}

// Deep Readonly
type DeepReadonly<T> = {
  readonly [P in keyof T]: T[P] extends object ? DeepReadonly<T[P]> : T[P]
}

// Immerã«ã‚ˆã‚‹ä¸å¤‰æ›´æ–°
import { produce } from 'immer'

function updateCharacter(character: SimCharacter, updates: Partial<SimCharacter>): SimCharacter {
  return produce(character, draft => {
    Object.assign(draft, updates)
  })
}
```

**åŠ¹æœ**: æ„å›³ã—ãªã„å¤‰æ›´é˜²æ­¢ã€ãƒã‚°æ—©æœŸç™ºè¦‹ã€ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°å®‰å…¨æ€§

---

### 9.7 ã‚¤ãƒ™ãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ ã®å‹å®‰å…¨åŒ–

**ç¾çŠ¶**: å˜ä¸€ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ã®ã¿

**æ¨å¥¨**:
```typescript
type EventMap = {
  'state:change': SerializedWorldState
  'character:move': { characterId: string; position: Position }
  'action:start': { characterId: string; actionId: ActionId }
  'action:complete': { characterId: string; actionId: ActionId }
  'error': Error
}

class EventEmitter<TEvents extends Record<string, unknown>> {
  private listeners = new Map<keyof TEvents, Set<(data: unknown) => void>>()

  on<K extends keyof TEvents>(event: K, handler: (data: TEvents[K]) => void): () => void {
    if (!this.listeners.has(event)) {
      this.listeners.set(event, new Set())
    }
    this.listeners.get(event)!.add(handler as (data: unknown) => void)
    return () => this.off(event, handler)
  }

  emit<K extends keyof TEvents>(event: K, data: TEvents[K]): void {
    const handlers = this.listeners.get(event)
    if (!handlers) return
    for (const handler of handlers) {
      try {
        handler(data)
      } catch (error) {
        this.emit('error' as K, error as TEvents[K])
      }
    }
  }
}
```

**åŠ¹æœ**: å‹å®‰å…¨ãªã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ã€è©³ç´°ãªã‚¤ãƒ™ãƒ³ãƒˆç¨®é¡ã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°æ”¹å–„

---

### 9.8 Zodã‚¹ã‚­ãƒ¼ãƒã¨å‹ã®çµ±åˆ

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/lib/mapLoader.ts`, `src/lib/characterLoader.ts`

**æ¨å¥¨**:
```typescript
import { z } from 'zod'

// ã‚¹ã‚­ãƒ¼ãƒã‹ã‚‰å‹ã‚’ç”Ÿæˆ
const ObstacleConfigSchema = z.object({
  id: z.string().optional(),
  row: z.number(),
  col: z.number(),
  tileWidth: z.number().min(2, 'Minimum width is 2'),
  tileHeight: z.number().min(2, 'Minimum height is 2'),
  label: z.string().optional(),
  type: z.enum(['building', 'zone']).default('building'),
}).refine(
  data => {
    if (data.type === 'zone') {
      return data.tileWidth >= 4 && data.tileHeight >= 4
    }
    return true
  },
  { message: 'Zone minimum size is 4x4' }
)

type ObstacleConfig = z.infer<typeof ObstacleConfigSchema>

// ä½¿ç”¨
function loadObstacles(data: unknown): ObstacleConfig[] {
  return z.array(ObstacleConfigSchema).parse(data)
}
```

**åŠ¹æœ**: ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã¨å‹ã®åŒæœŸã€è©³ç´°ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€å‹å®‰å…¨æ€§å‘ä¸Š

---

### 9.9 æŠ½è±¡åŒ–ã®å„ªå…ˆåº¦ä¸€è¦§

| å¯¾å¿œé …ç›® | å„ªå…ˆåº¦ | åŠ¹æœ | å·¥æ•° |
|---------|-------|------|------|
| Discriminated Unionå‹ | é«˜ | å‹å®‰å…¨æ€§å¤§å¹…å‘ä¸Š | ä½ |
| ä¾å­˜æ€§æ³¨å…¥ï¼ˆSimulationEngineï¼‰ | é«˜ | ãƒ†ã‚¹ã‚¿ãƒ“ãƒªãƒ†ã‚£å‘ä¸Š | ä¸­ |
| Brandedå‹ï¼ˆIDåŒºåˆ¥ï¼‰ | é«˜ | ãƒã‚°é˜²æ­¢ | ä½ |
| Resultå‹å°å…¥ | é«˜ | ã‚¨ãƒ©ãƒ¼å‡¦ç†çµ±ä¸€ | ä¸­ |
| BehaviorDecideræˆ¦ç•¥ãƒ‘ã‚¿ãƒ¼ãƒ³ | ä¸­ | æ‹¡å¼µæ€§å‘ä¸Š | ä¸­ |
| ActionHandleræŠ½è±¡åŒ– | ä¸­ | æ–°ã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¿½åŠ å®¹æ˜“ | é«˜ |
| ã‚¸ã‚§ãƒãƒªãƒƒã‚¯CRUD | ä¸­ | ã‚³ãƒ¼ãƒ‰é‡è¤‡å‰Šæ¸› | ä¸­ |
| å‹å®‰å…¨ã‚¤ãƒ™ãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ  | ä¸­ | ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†æ”¹å–„ | ä¸­ |
| Zodã‚¹ã‚­ãƒ¼ãƒçµ±åˆ | ä½ | ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³çµ±ä¸€ | ä¸­ |
| ä¸å¤‰æ€§å¼·åŒ–ï¼ˆImmerï¼‰ | ä½ | å‰¯ä½œç”¨å‰Šæ¸› | ä½ |

---

### 9.10 æŠ½è±¡åŒ–ã«ã‚ˆã‚‹æœŸå¾…åŠ¹æœ

| æŒ‡æ¨™ | ç¾çŠ¶ | æŠ½è±¡åŒ–å¾Œï¼ˆæ¨å®šï¼‰ |
|------|------|-----------------|
| ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ | 0% | >80%å¯èƒ½ |
| å‹ã‚¨ãƒ©ãƒ¼ã§ã®æ¤œå‡ºç‡ | ~60% | >95% |
| æ–°ã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¿½åŠ å·¥æ•° | é«˜ | ä½ |
| æ–°ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸è¿½åŠ å·¥æ•° | é«˜ | ä½ |
| LLMãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ | ãªã— | è‡ªå‹• |
| ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°å®‰å…¨æ€§ | ä½ | é«˜ |

---

## å¤‰æ›´å±¥æ­´

| æ—¥ä»˜ | å†…å®¹ |
|------|------|
| 2026-01-22 | åˆç‰ˆä½œæˆ |
| 2026-01-22 | ãƒ­ã‚¸ãƒƒã‚¯é‡è¤‡ã®è©³ç´°åˆ†æã‚’è¿½åŠ  |
| 2026-01-22 | æŠ½è±¡åŒ–ãƒ»å …ç‰¢åŒ–ã®æ©Ÿä¼šã‚’è¿½åŠ  |
