# LLMè¡Œå‹•æ±ºå®šã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆ

## æ¦‚è¦

ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®è¡Œå‹•ã‚’LLMãŒæ±ºå®šã™ã‚‹ã‚·ã‚¹ãƒ†ãƒ ã€‚
ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã€ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã€ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®šã‚’è€ƒæ…®ã—ã¦æ¬¡ã®è¡Œå‹•ã‚’é¸æŠã™ã‚‹ã€‚

## è¤‡æ•°ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®ä¸¦åˆ—å‹•ä½œ

### å‹•ä½œæ–¹å¼

- **ç‹¬ç«‹å‹•ä½œ**: å„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã¯ç‹¬ç«‹ã—ã¦å‹•ä½œã™ã‚‹
- **ä¸¦åˆ—LLMå‘¼ã³å‡ºã—**: è¤‡æ•°ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒåŒæ™‚ã«ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Œäº†ã—ãŸå ´åˆã€LLMå‘¼ã³å‡ºã—ã‚‚ä¸¦åˆ—ã§å®Ÿè¡Œï¼ˆåŒæ™‚ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼‰
- **éåŒæœŸå‡¦ç†**: å„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®LLMå¿œç­”ã¯ç‹¬ç«‹ã—ã¦å‡¦ç†ã•ã‚Œã‚‹

### å®Ÿè£…ä¸Šã®è€ƒæ…®

```typescript
// å„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¯ç‹¬ç«‹ã—ãŸãƒ«ãƒ¼ãƒ—ã§å‹•ä½œ
async function simulateCharacter(characterId: string) {
  while (running) {
    // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Œäº†ã‚’å¾…æ©Ÿ
    await waitForActionComplete(characterId)

    // LLMå‘¼ã³å‡ºã—ï¼ˆä»–ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’å¾…ãŸãªã„ï¼‰
    const decision = await behaviorDecider.decide(character, context)

    // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
    await executeAction(characterId, decision)
  }
}

// å…¨ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’ä¸¦åˆ—ã§èµ·å‹•
characters.forEach(c => simulateCharacter(c.id))
```

## ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†

### ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®æµã‚Œ

```
åˆæ—¥: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¨­å®š
  â†“
ç¿Œæ—¥: å‰æ—¥ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å¼•ãç¶™ã
  â†“
LLMãŒçŠ¶æ³ã«å¿œã˜ã¦èª¿æ•´
```

### ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æ§‹é€ 

```typescript
interface ScheduleEntry {
  time: string           // "09:00" (HH:MMå½¢å¼)
  activity: string       // "ä»•äº‹", "æ˜¼é£Ÿ", "è‡ªç”±æ™‚é–“"
  location?: string      // å ´æ‰€ï¼ˆä»»æ„ï¼‰
  note?: string          // å‚™è€ƒ
}

interface DailySchedule {
  characterId: string    // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ID
  day: number            // ãƒ¯ãƒ¼ãƒ«ãƒ‰æ—¥æ•° (WorldTime.day)
  entries: ScheduleEntry[]
}
```

### ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ä¾‹

```json
{
  "characterId": "kanon",
  "day": 1,
  "entries": [
    { "time": "07:00", "activity": "èµ·åºŠ" },
    { "time": "08:00", "activity": "æœé£Ÿ" },
    { "time": "09:00", "activity": "ä»•äº‹", "location": "ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³" },
    { "time": "12:00", "activity": "æ˜¼é£Ÿ" },
    { "time": "13:00", "activity": "ä»•äº‹", "location": "ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³" },
    { "time": "18:00", "activity": "é€€å‹¤" },
    { "time": "19:00", "activity": "å¤•é£Ÿ" },
    { "time": "20:00", "activity": "è‡ªç”±æ™‚é–“" },
    { "time": "23:00", "activity": "å°±å¯" }
  ]
}
```

## LLMå‘¼ã³å‡ºã—

### å‘¼ã³å‡ºã—ã‚¿ã‚¤ãƒŸãƒ³ã‚°

| ã‚¿ã‚¤ãƒŸãƒ³ã‚° | ãƒˆãƒªã‚¬ãƒ¼ | å‡¦ç† |
|-----------|---------|------|
| é€šå¸¸ | ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Œäº† | æ¬¡ã®è¡Œå‹•ã‚’æ±ºå®š |
| ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å‰²ã‚Šè¾¼ã¿ | å„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹10%æœªæº€ | å¼·åˆ¶ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆè©³ç´°ã¯LLMæ±ºå®šï¼‰ |
| ç’°å¢ƒå‰²ã‚Šè¾¼ã¿ | ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™ºå‹• | LLMãŒä¸­æ–­åˆ¤æ–­ |

### ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å‰²ã‚Šè¾¼ã¿

ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒ10%æœªæº€ã«ãªã‚‹ã¨å¼·åˆ¶ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒç™ºå‹•ã€‚
ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ç¨®åˆ¥ã¯å¼·åˆ¶ã ãŒã€å…·ä½“çš„ãªå†…å®¹ï¼ˆå ´æ‰€ãªã©ï¼‰ã¯LLMãŒæ±ºå®šã€‚

```
satiety < 10%
  â†“
ã‚·ã‚¹ãƒ†ãƒ : ã€Œé£Ÿäº‹ã€ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å¼·åˆ¶
  â†“
ã‚·ã‚¹ãƒ†ãƒ : é£Ÿäº‹å¯èƒ½ãªå ´æ‰€ãƒ»æ–™é‡‘ä¸€è¦§ã‚’æç¤º
  [ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³A: 800å††, ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³B: 1500å††, è‡ªå®…: 300å††]
  â†“
LLM: æ‰€æŒé‡‘ãƒ»è·é›¢ãƒ»å¥½ã¿ã‚’åŠ å‘³ã—ã¦é¸æŠ
  ã€Œæ‰€æŒé‡‘å°‘ãªã„ã‹ã‚‰è‡ªå®…ã§ã€
```

| ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ | å¼·åˆ¶ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ |
|-----------|---------------|
| satiety < 10% | eat |
| energy < 10% | sleep or rest |
| bladder < 10% | toilet |
| hygiene < 10% | bathe |

### ç’°å¢ƒå‰²ã‚Šè¾¼ã¿

ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç’°å¢ƒã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºå‹•ã—ã€LLMãŒä¸­æ–­ã™ã‚‹ã‹åˆ¤æ–­ã€‚

```
ãƒ¦ãƒ¼ã‚¶ãƒ¼: ã€Œåœ°éœ‡ã ï¼ã€ã‚¤ãƒ™ãƒ³ãƒˆç™ºå‹•
  â†“
LLM: ç¾åœ¨ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ»çŠ¶æ³ã‚’è€ƒæ…®ã—ã¦åˆ¤æ–­
  â†“
â”œâ”€ ä¸­æ–­ã™ã‚‹ â†’ é¿é›£è¡Œå‹•ãªã©
â””â”€ ä¸­æ–­ã—ãªã„ â†’ ç¾åœ¨ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ç¶™ç¶š
```

| ã‚¤ãƒ™ãƒ³ãƒˆä¾‹ | LLMåˆ¤æ–­ä¾‹ |
|-----------|----------|
| åœ°éœ‡ã ï¼ | ä»•äº‹ä¸­æ–­ â†’ å®‰å…¨ç¢ºä¿ |
| é›ªãŒé™ã‚Šå§‹ã‚ãŸ | äºˆå®šé€šã‚Šç¶šè¡Œ or æ—©ã‚ã«å¸°å®… |
| æ•‘æ€¥è»Šã®éŸ³ | æ°—ã«ã›ãšç¶šè¡Œ or æ§˜å­ã‚’è¦‹ã«è¡Œã |
| åœé›»ã—ãŸ | çŠ¶æ³ã«å¿œã˜ã¦å¯¾å¿œ |

## ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«

### æ§‹é€ 

```typescript
interface CharacterProfile {
  name: string
  personality: string        // æ€§æ ¼
  tendencies: string[]       // è¡Œå‹•å‚¾å‘
  customPrompt?: string      // è‡ªç”±å…¥åŠ›æ¬„
}
```

### ä¾‹

```typescript
const aliceProfile: CharacterProfile = {
  name: "ã‚¢ãƒªã‚¹",
  personality: "æ˜ã‚‹ãç¤¾äº¤çš„ã ãŒã€å°‘ã—å¿ƒé…æ€§ãªé¢ã‚‚ã‚ã‚‹",
  tendencies: [
    "ç¯€ç´„å¿—å‘ã§å®‰ã„åº—ã‚’é¸ã¶",
    "æœå‹ã§æ—©èµ·ããŒå¾—æ„",
    "äººã¨è©±ã™ã®ãŒå¥½ã",
  ],
  customPrompt: `
    3å¹´å‰ã«éƒ½ä¼šã‹ã‚‰å¼•ã£è¶Šã—ã¦ããŸã€‚
    æ¯æœã‚³ãƒ¼ãƒ’ãƒ¼ã‚’é£²ã¾ãªã„ã¨èª¿å­ãŒå‡ºãªã„ã€‚
    NPCå¤ªéƒã¨ã¯å¹¼ãªã˜ã¿ã§è¦ªã—ã„ã€‚
    æ°´æ›œæ—¥ã¯å¿…ãšå›³æ›¸é¤¨ã«è¡Œãç¿’æ…£ãŒã‚ã‚‹ã€‚
  `,
}
```

## è¡Œå‹•é¸æŠãƒ•ãƒ­ãƒ¼

### é€šå¸¸ãƒ•ãƒ­ãƒ¼

```
ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Œäº† â†’ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚«ã‚¦ãƒ³ãƒˆ+1
  â†“
ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å‰²ã‚Šè¾¼ã¿åˆ¤å®šï¼ˆã„ãšã‚Œã‹ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ < 10%ï¼‰
  â”œâ”€ YES â†’ ç·Šæ€¥ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œï¼ˆã‚«ã‚¦ãƒ³ãƒˆã¯é€²ã‚€ãŒã‚·ã‚¹ãƒ†ãƒ ç§»å‹•ã¯ã‚¹ã‚­ãƒƒãƒ—ï¼‰
  â””â”€ NO â†“
ã‚·ã‚¹ãƒ†ãƒ è‡ªå‹•ç§»å‹•åˆ¤å®šï¼ˆã‚«ã‚¦ãƒ³ãƒˆ == 3ï¼‰
  â”œâ”€ YES â†’ 3ãƒãƒƒãƒ—ä»¥å†…ã®ãƒ©ãƒ³ãƒ€ãƒ ãªå ´æ‰€ã¸ç§»å‹• â†’ ã‚«ã‚¦ãƒ³ãƒˆãƒªã‚»ãƒƒãƒˆ
  â””â”€ NO â†“
ã‚·ã‚¹ãƒ†ãƒ : çŠ¶æ³æƒ…å ±ã‚’åé›†
  - ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
  - ç¾åœ¨æ™‚åˆ»ãƒ»ç¾åœ¨åœ°
  - ä»Šæ—¥ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
  - å‘¨å›²ã®æ–½è¨­ãƒ»NPC
  â†“
LLM: æ¬¡ã®è¡Œå‹•ã‚’æ±ºå®š
  â†“
ã‚·ã‚¹ãƒ†ãƒ : é¸æŠã•ã‚ŒãŸã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®è©³ç´°æƒ…å ±ã‚’æç¤º
  ï¼ˆä¾‹: é£Ÿäº‹å¯èƒ½ãªå ´æ‰€ä¸€è¦§ï¼‰
  â†“
LLM: å…·ä½“çš„ãªå†…å®¹ã‚’é¸æŠ
  â†“
ã‚·ã‚¹ãƒ†ãƒ : ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
```

### ã‚·ã‚¹ãƒ†ãƒ è‡ªå‹•ç§»å‹•

LLMã®åˆ¤æ–­ã¨ã¯åˆ¥ã«ã€ã‚·ã‚¹ãƒ†ãƒ ãŒå®šæœŸçš„ã«ç§»å‹•ã‚’ç™ºå‹•ã™ã‚‹ä»•çµ„ã¿:

- **ç›®çš„**: åŒã˜å ´æ‰€ã«ç•™ã¾ã‚‹ã“ã¨ã‚’é˜²ãã€å¶ç™ºçš„ãªå‡ºä¼šã„ã‚’å‰µå‡º
- **ç™ºå‹•æ¡ä»¶**: 3å›ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Œäº†ã”ã¨ï¼ˆã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ãƒ™ãƒ¼ã‚¹ï¼‰
- **è¡Œãå…ˆ**: 3ãƒãƒƒãƒ—ä»¥å†…ã®ãƒ©ãƒ³ãƒ€ãƒ ãªå ´æ‰€
- **ç·Šæ€¥æ™‚**: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å‰²ã‚Šè¾¼ã¿ä¸­ã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆã‚«ã‚¦ãƒ³ãƒˆã¯é€²ã‚€ï¼‰

### LLMãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ§‹æˆ

```
ã‚ãªãŸã¯${character.name}ã§ã™ã€‚

ã€æ€§æ ¼ã€‘
${character.personality}

ã€è¡Œå‹•å‚¾å‘ã€‘
${character.tendencies.join('\n')}

ã€ãã®ä»–ã€‘
${character.customPrompt || 'ãªã—'}

ã€ç›´è¿‘ã®ä¼šè©±ã€‘ï¼ˆç¡çœ ã§ã‚¯ãƒªã‚¢ï¼‰
${recentConversations.map(c => `- ${c.npcName}: ${c.summary}`).join('\n') || 'ãªã—'}

ã€ä¸­æœŸè¨˜æ†¶ã€‘
${midTermMemories.map(m => `- ${m.content}`).join('\n') || 'ãªã—'}

ã€ä»Šæ—¥ã®è¡Œå‹•ã€‘
${todayActions.map(a => `- ${a.time} ${a.actionId}${a.target ? ` â†’ ${a.target}` : ''}${a.durationMinutes ? ` (${a.durationMinutes}åˆ†)` : ''}${a.reason ? ` [${a.reason}]` : ''}`).join('\n') || 'ãªã—'}

ã€ç¾åœ¨ã®çŠ¶æ³ã€‘
- æ™‚åˆ»: ${time}
- å ´æ‰€: ${location}
- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: satiety=${satiety}, energy=${energy}, ...
- æ‰€æŒé‡‘: ${money}å††

ã€ä»Šæ—¥ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã€‘
${schedule}

ã€åˆ©ç”¨å¯èƒ½ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã€‘
${availableActions}

ã€å‘¨å›²ã®æ–½è¨­ã€‘
${nearbyFacilities}

ã€å‘¨å›²ã®NPCã€‘
${nearbyNPCs}

æ¬¡ã®è¡Œå‹•ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚
```

### å½“æ—¥ã®ä¸€æ™‚çŠ¶æ…‹

ç¡çœ ã§ã‚¯ãƒªã‚¢ã•ã‚Œã‚‹ã‚ªãƒ³ãƒ¡ãƒ¢ãƒªã®æƒ…å ±ã€‚

```typescript
interface CharacterDailyState {
  recentConversations: ConversationSummary[]  // ç›´è¿‘ã®ä¼šè©±
}
```

### ç›´è¿‘ã®ä¼šè©±

- ãã®æ—¥ã®ä¼šè©±ã‚µãƒãƒªãƒ¼ã‚’ä¿æŒ
- ç¡çœ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œæ™‚ã«ã‚¯ãƒªã‚¢

### ä¸­æœŸè¨˜æ†¶

- ä¼šè©±ä¸­ã«æŠ½å‡ºã—ãŸã€Œè¡Œå‹•ã«å½±éŸ¿ã™ã‚‹æƒ…å ±ã€
- é‡è¦åº¦ã«å¿œã˜ã¦æœ‰åŠ¹æœŸé™ã‚’è¨­å®šï¼ˆå½“æ—¥ã€œæœ€å¤§3æ—¥ï¼‰
- è»½é‡ãƒ†ãƒ¼ãƒ–ãƒ«ã«ä¿å­˜
- ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«å«ã‚ã‚‹

| é‡è¦åº¦ | æœ‰åŠ¹æœŸé™ | ä¾‹ |
|--------|---------|-----|
| ä½ | å½“æ—¥ | ã€Œå¤ªéƒã¨å¤•æ–¹ã«é§…å‰ã§å¾…ã¡åˆã‚ã›ã€ |
| ä¸­ | 2æ—¥ | ã€ŒèŠ±å­ãŒé¢¨é‚ªã²ã„ã¦ãŸã€ |
| é«˜ | 3æ—¥ | ã€Œæ˜å¾Œæ—¥ã«å¤ªéƒã¨ç´„æŸã€ |

```typescript
interface MidTermMemory {
  id: string
  content: string
  importance: "low" | "medium" | "high"
  createdAt: Date
  expiresAt: Date
  sourceNpcId?: string
}
```

### LLMå‡ºåŠ›å½¢å¼

```typescript
interface BehaviorDecision {
  action: string              // "eat", "move", "talk", "idle", etc.
  target?: string             // å¯¾è±¡ï¼ˆæ–½è¨­ID, NPC ID, ãƒãƒƒãƒ—IDãªã©ï¼‰
  reason: string              // ç†ç”±ï¼ˆãƒ­ã‚°ç”¨ï¼‰
  durationMinutes?: number    // å®Ÿè¡Œæ™‚é–“ï¼ˆåˆ†ï¼‰- å¯å¤‰æ™‚é–“ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®å ´åˆ
  scheduleUpdate?: {          // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å¤‰æ›´ï¼ˆä»»æ„ï¼‰
    type: "add" | "remove" | "modify"
    entry: ScheduleEntry
  }
}
```

#### durationMinutes ã«ã¤ã„ã¦

- `eat`, `sleep`, `toilet`, `bathe`, `rest`, `work` ã®å¯å¤‰æ™‚é–“ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã§ä½¿ç”¨
- å„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã® `durationRange` å†…ã§æŒ‡å®š
- æ¬¡ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã¾ã§ã®æ™‚é–“ã‚’è€ƒæ…®ã—ã¦é©åˆ‡ãªå€¤ã‚’é¸æŠ
- `talk`, `move`, `idle`, `thinking` ã¯å›ºå®šã¾ãŸã¯å³æ™‚ãªã®ã§ `null`

### å‡ºåŠ›ä¾‹

```json
{
  "action": "eat",
  "target": "restaurant_a",
  "reason": "ãŠæ˜¼ã®æ™‚é–“ã ã—ã€è¿‘ãã®ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³Aã§é£Ÿã¹ã‚ˆã†",
  "scheduleUpdate": null
}
```

```json
{
  "action": "move",
  "target": "home",
  "reason": "é›ªãŒå¼·ããªã£ã¦ããŸã®ã§æ—©ã‚ã«å¸°å®…ã™ã‚‹",
  "scheduleUpdate": {
    "type": "modify",
    "entry": { "time": "18:00", "activity": "å¸°å®…ï¼ˆäºˆå®šå¤‰æ›´ï¼‰" }
  }
}
```

## ã‚¢ã‚¯ã‚·ãƒ§ãƒ³è©³ç´°é¸æŠ

ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ç¨®åˆ¥ãŒæ±ºã¾ã£ãŸå¾Œã€å…·ä½“çš„ãªå†…å®¹ã‚’LLMãŒé¸æŠã€‚

### é£Ÿäº‹ã®å ´åˆ

```
LLM: action="eat"
  â†“
ã‚·ã‚¹ãƒ†ãƒ : é£Ÿäº‹å¯èƒ½ãªå ´æ‰€ã‚’æç¤º
  [
    { id: "home_kitchen", name: "è‡ªå®…", cost: 300, distance: "é ã„" },
    { id: "restaurant_a", name: "ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³A", cost: 800, distance: "è¿‘ã„" },
    { id: "restaurant_b", name: "é«˜ç´šãƒ¬ã‚¹ãƒˆãƒ©ãƒ³", cost: 2000, distance: "ä¸­" },
  ]
  â†“
LLM: é¸æŠ
  {
    "target": "restaurant_a",
    "reason": "è¿‘ã„ã—æ‰‹é ƒãªå€¤æ®µã ã‹ã‚‰"
  }
```

### ä¼šè©±ã®å ´åˆ

```
LLM: action="talk"
  â†“
ã‚·ã‚¹ãƒ†ãƒ : ä¼šè©±å¯èƒ½ãªNPCã‚’æç¤º
  [
    { id: "npc_taro", name: "å¤ªéƒ", location: "è¿‘ã", relationship: "å¹¼ãªã˜ã¿" },
    { id: "npc_hanako", name: "èŠ±å­", location: "å°‘ã—é ã„", relationship: "çŸ¥äºº" },
  ]
  â†“
LLM: é¸æŠ + ä¼šè©±ç›®çš„
  {
    "target": "npc_taro",
    "goal": "æœ€è¿‘ã®æ§˜å­ã‚’èããŸã„",
    "reason": "ä¹…ã—ã¶ã‚Šã«ä¼šã£ãŸã‹ã‚‰è©±ã—ãŸã„"
  }
```

## å®Ÿè£…

### LLMBehaviorDecider

LLMã‚’ä½¿ç”¨ã—ãŸè¡Œå‹•æ±ºå®šã‚¯ãƒ©ã‚¹ã€‚

```typescript
interface BehaviorDecider {
  decide(
    character: SimCharacter,
    context: BehaviorContext
  ): Promise<BehaviorDecision>
}

class LLMBehaviorDecider implements BehaviorDecider {
  async decide(character, context): Promise<BehaviorDecision> {
    // 1. thinking ã‚¢ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹ï¼ˆğŸ¤”è¡¨ç¤ºï¼‰
    // 2. LLMã«ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ç¨®åˆ¥ã‚’æ±ºå®šã•ã›ã‚‹ï¼ˆæ§‹é€ åŒ–å‡ºåŠ›ï¼‰
    // 3. è©³ç´°é¸æŠãŒå¿…è¦ãªå ´åˆã€2æ®µéšç›®ã®LLMå‘¼ã³å‡ºã—ï¼ˆæ–½è¨­é¸æŠç­‰ï¼‰
    // 4. thinking å®Œäº†
    // 5. æ±ºå®šã«åŸºã¥ã„ã¦ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œã¾ãŸã¯ç§»å‹•é–‹å§‹
  }
}
```

### thinking ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

LLMãŒè¡Œå‹•ã‚’æ±ºå®šã—ã¦ã„ã‚‹é–“ã€ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®é ­ä¸Šã«ğŸ¤”ã‚’è¡¨ç¤ºã€‚

- duration: 0ï¼ˆæ‰‹å‹•å®Œäº†ï¼‰
- LLMå‘¼ã³å‡ºã—å®Œäº†æ™‚ã« `forceCompleteAction()` ã§çµ‚äº†
- ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚å¿…ãšçµ‚äº†ã•ã›ã‚‹

### å¯å¤‰æ™‚é–“ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

LLMãŒã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®å®Ÿè¡Œæ™‚é–“ã‚’æŒ‡å®šã§ãã‚‹ä»•çµ„ã¿ã€‚

```typescript
// world-config.json ã® actions ã‚»ã‚¯ã‚·ãƒ§ãƒ³
{
  "sleep": {
    "durationRange": { "min": 30, "max": 480, "default": 480 },
    "perMinute": { "energy": 0.208, "mood": 0.042 }
  },
  "eat": {
    "durationRange": { "min": 15, "max": 60, "default": 30 },
    "perMinute": { "satiety": 1.67, "mood": 0.33 }
  }
}
```

- **durationRange**: æœ€å°ã€œæœ€å¤§æ™‚é–“ï¼ˆåˆ†ï¼‰
- **perMinute**: åˆ†ã‚ãŸã‚Šã®åŠ¹æœ
- **åŠ¹æœè¨ˆç®—**: perMinute Ã— durationMinutes
- LLMãŒã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’è€ƒæ…®ã—ã¦é©åˆ‡ãªæ™‚é–“ã‚’é¸æŠ

### PendingActionï¼ˆç§»å‹•å¾Œã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼‰

æ–½è¨­ã‚„NPCãŒç¾åœ¨ä½ç½®ã‹ã‚‰é›¢ã‚Œã¦ã„ã‚‹å ´åˆã€ç§»å‹•å®Œäº†å¾Œã«ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã€‚

```typescript
interface PendingAction {
  actionId: ActionId
  facilityId?: string       // æ–½è¨­ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ç”¨
  targetNpcId?: string      // talk ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ç”¨
  facilityMapId: string
  reason?: string
  durationMinutes?: number  // å¯å¤‰æ™‚é–“ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ç”¨
}
```

ãƒ•ãƒ­ãƒ¼:
```
LLMæ±ºå®š: eat at restaurant_aï¼ˆåˆ¥ãƒãƒƒãƒ—ï¼‰
  â†“
PendingAction ã‚’è¨­å®š
  â†“
restaurant_a ãŒã‚ã‚‹ãƒãƒƒãƒ—ã¸ç§»å‹•é–‹å§‹
  â†“
ç§»å‹•å®Œäº†
  â†“
PendingAction ã‚’å®Ÿè¡Œï¼ˆeat ã‚¢ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹ï¼‰
```

### æ–½è¨­æ¤œç´¢ãƒ­ã‚¸ãƒƒã‚¯

ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®å®Ÿè¡Œå¯å¦ãƒã‚§ãƒƒã‚¯ã¯ã€Œãƒãƒƒãƒ—å…¨ä½“ã€ã§åˆ¤å®šã€‚

- æ—§: ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒæ–½è¨­å†…ã«ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
- æ–°: ãƒãƒƒãƒ—ã«è©²å½“æ–½è¨­ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ â†’ ç§»å‹• + ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œ

ã“ã‚Œã«ã‚ˆã‚Šã€LLMã¯ã€Œãƒãƒƒãƒ—å†…ã®ã©ã®æ–½è¨­ã§ã‚‚é¸æŠå¯èƒ½ã€ã«ãªã‚‹ã€‚
